/*! ngs3upload 17-03-2014 */
!function(){angular.module("ngS3upload.config",[]).value("ngS3upload.config",{debug:!0}).config(["$compileProvider",function(a){angular.isDefined(a.urlSanitizationWhitelist)?a.urlSanitizationWhitelist(/^\s*(https?|ftp|mailto|file|data):/):a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|file|data):/)}]),angular.module("ngS3upload.directives",[]),angular.module("ngS3upload",["ngS3upload.config","ngS3upload.directives","ngS3upload.services","ngSanitize"]),angular.module("ngS3upload.services",[]).service("S3Uploader",["$http","$q","$window",function(a,b){this.uploads=0;var c=this;this.getUploadOptions=function(c){var d=b.defer();return a.get(c).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},this.randomString=function(a){for(var b="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",c="",d=a;d>0;--d)c+=b[Math.round(Math.random()*(b.length-1))];return c},this.upload=function(a,d,e,f,g,h,i,j,k,l){function m(b){a.$apply(function(){a.progress=b.lengthComputable?Math.round(100*b.loaded/b.total):"unable to compute","function"==typeof q.notify&&q.notify({type:"progress",value:a.progress})})}function n(){a.$apply(function(){c.uploads--,a.uploading=!1,a.success=!0,q.resolve()})}function o(){a.$apply(function(){c.uploads--,a.uploading=!1,a.success=!1,q.reject()})}function p(){a.$apply(function(){c.uploads--,a.uploading=!1,a.success=!1,q.reject()})}var q=b.defer();a.attempt=!0;var r=new FormData;for(var s in l){var t=l[s];r.append(t.name,t.value)}r.append("key",e),r.append("acl",f),r.append("Content-Type",k.type),r.append("AWSAccessKeyId",h),r.append("policy",i),r.append("signature",j),r.append("file",k);var u=new XMLHttpRequest;return u.upload.addEventListener("progress",m,!1),u.addEventListener("load",n,!1),u.addEventListener("error",o,!1),u.addEventListener("abort",p,!1),a.uploading=!0,this.uploads++,u.open("POST",d,!0),u.setRequestHeader("Accept","application/json"),u.send(r),q.promise},this.isUploading=function(){return this.uploads>0}}]),angular.module("ngS3upload.directives",[]).directive("s3Upload",["$parse","S3Uploader",function(a,b){return{restrict:"AC",require:"?ngModel",replace:!0,transclude:!1,scope:!0,controller:["$scope","$element","$attrs","$transclude",function(a){a.attempt=!1,a.success=!1,a.uploading=!1,a.barClass=function(){return{"bar-success":a.attempt&&!a.uploading&&a.success}}}],compile:function(){return{pre:function(a,b,c){if(angular.isUndefined(c.bucket))throw Error("bucket is a mandatory attribute")},post:function(a,c,d,e){var f=angular.extend({},a.$eval(d.s3UploadOptions||d.options));f=angular.extend({submitOnChange:!0,getOptionsUri:"/getS3Options",acl:"public-read",uploadingKey:"uploading",folder:""},f),f.uploadStartCallback();var g=a.$eval(d.bucket),h=angular.element(c.children()[0]),i=angular.element(c.find("input")[0]);h.bind("click",function(){i[0].click()}),e.$render=function(){a.filename=e.$viewValue};var j=function(){var c=i[0].files[0],d=c.name,h=d.split(".").pop();a.$apply(function(){b.getUploadOptions(f.getOptionsUri).then(function(d){e.$setValidity("uploading",!1);var i="http://"+g+".s3.amazonaws.com/",j=f.folder+(new Date).getTime()+"-"+b.randomString(16)+"."+h;b.upload(a,i,j,f.acl,c.type,d.AWSAccessKeyId,d.policy,d.signature,c,f.extraHeaders).then(function(){e.$setViewValue(i+j),a.filename=e.$viewValue,f.uploadDoneCallback(a.filename,j),e.$setValidity("uploading",!0),e.$setValidity("succeeded",!0)},function(){a.filename=e.$viewValue,f.uploadErrorCallback(),e.$setValidity("uploading",!0),e.$setValidity("succeeded",!1)})},function(a){throw Error("Can't receive the needed options for S3 "+a)})})};c.bind("change",function(){f.submitOnChange&&j()})}}},template:'<div class="upload-wrap"><button class="btn btn-primary" type="button" ng-show="!filename"><span ng-if="!filename">Choose file</span></button><div class="progress" ng-show="attempt"><div class="progress-bar" role="progressbar" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ progress }}%;"><span class="sr-only">{{ progress }}%</span></div></div><input type="file" style="display: none"/></div>'}}])}(window,document);